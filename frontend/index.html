<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualización de Nodos OSM</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="map"></div>
  <div id="control-panel">
    <div id="points-control" class="control-group">
      <h3>Número de Puntos</h3>
      <input type="number" id="points-number" min="1" max="1000" value="10" placeholder="Número de puntos">
      <button onclick="updatePoints()">Buscar Puntos</button>
    </div>
    <div id="node-info" class="control-group">
      <h3>Información del Nodo</h3>
      <div id="selected-node-info">
        <p><strong>Nombre:</strong> <span id="node-name">-</span></p>
        <div class="coordinate-box">
          <p><strong>Coordenadas:</strong></p>
          <p>Latitud: <span id="node-lat">-</span></p>
          <p>Longitud: <span id="node-lng">-</span></p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Inicializar el mapa
    const map = L.map('map').setView([0, 0], 2);

    // Añadir capa base de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let currentGeoJsonLayer = null;

    // Función para mostrar un mensaje de error en el mapa
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.style.position = 'absolute';
      errorDiv.style.top = '10px';
      errorDiv.style.left = '50%';
      errorDiv.style.transform = 'translateX(-50%)';
      errorDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.8)';
      errorDiv.style.color = 'white';
      errorDiv.style.padding = '10px';
      errorDiv.style.borderRadius = '5px';
      errorDiv.style.zIndex = '1000';
      errorDiv.textContent = message;
      document.body.appendChild(errorDiv);

      setTimeout(() => {
        document.body.removeChild(errorDiv);
      }, 5000);
    }

    // Función para actualizar la información del nodo seleccionado
    function updateNodeInfo(feature) {
      const nodeInfo = document.getElementById('node-info');
      const nodeName = document.getElementById('node-name');
      const nodeLat = document.getElementById('node-lat');
      const nodeLng = document.getElementById('node-lng');

      nodeInfo.classList.add('active');
      nodeName.textContent = feature.properties.name || 'Sin nombre';
      nodeLat.textContent = feature.geometry.coordinates[1].toFixed(6);
      nodeLng.textContent = feature.geometry.coordinates[0].toFixed(6);
    }

    // Función para cargar datos GeoJSON desde el backend
    async function loadGeoJSON(limit = 10) {
      try {
        // Eliminar la capa anterior si existe
        if (currentGeoJsonLayer) {
          map.removeLayer(currentGeoJsonLayer);
        }

        const response = await fetch(`http://localhost:3000/api/point/geojson?limit=${limit}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        // Añadir los datos GeoJSON al mapa
        currentGeoJsonLayer = L.geoJSON(data, {
          onEachFeature: (feature, layer) => {
            // Añadir un popup con información básica
            const { osm_id, name } = feature.properties;
            layer.bindPopup(`
              <strong>ID:</strong> ${osm_id}<br>
              <strong>Nombre:</strong> ${name || 'N/A'}
            `);

            // Añadir evento de clic para mostrar información detallada
            layer.on('click', () => {
              updateNodeInfo(feature);
            });
          }
        }).addTo(map);

        // Ajustar el mapa para mostrar todos los nodos
        map.fitBounds(currentGeoJsonLayer.getBounds());
      } catch (error) {
        console.error('Error al cargar los datos GeoJSON:', error);
        showError('No se pudieron cargar los datos del mapa. Por favor, inténtalo de nuevo más tarde.');
      }
    }

    // Función para actualizar los puntos según el número ingresado
    function updatePoints() {
      const pointsNumber = document.getElementById('points-number').value;
      if (pointsNumber < 1 || pointsNumber > 1000) {
        showError('Por favor, ingrese un número entre 1 y 1000');
        return;
      }
      loadGeoJSON(pointsNumber);
    }

    // Cargar los datos iniciales
    loadGeoJSON();
  </script>
</body>
</html>